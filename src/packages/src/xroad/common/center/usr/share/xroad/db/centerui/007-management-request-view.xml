<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="niis" id="007-management-request-view">
        <createView fullDefinition="false" viewName="management_request_view">
            SELECT r.id,
                   r.origin,
                   r.comments,
                   r.type,
                   r.security_server_id,

                   r.request_processing_id,
                   rp.status AS request_processing_status,

                   ssc.name  AS security_server_owner_name,
                   i.xroad_instance,
                   i.member_code,
                   i.member_class,
                   i.server_code,
                   r.created_at
            FROM requests r
                     LEFT JOIN request_processings rp ON (rp.id = r.request_processing_id)
                     LEFT JOIN identifiers i ON (i.id = r.security_server_id)
                     LEFT JOIN member_classes mc ON (mc.code = i.member_class)
                     LEFT JOIN security_server_clients ssc
                               ON (ssc.member_code = i.member_code
                                   AND ssc.member_class_id = mc.id
                                   AND ssc.type = 'XRoadMember')
        </createView>
    </changeSet>
</databaseChangeLog>
