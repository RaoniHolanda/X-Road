<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <include file="centerui/000-ensure-supported-version.xml" relativeToChangelogFile="true"/>
    <include file="centerui/001-baseline.xml" relativeToChangelogFile="true"/>
    <include file="centerui/002-hibernate-sequence.xml" relativeToChangelogFile="true"/>
    <include file="centerui/003-apikeys.xml" relativeToChangelogFile="true"/>
    <include file="centerui/004-identifiers-fix.xml" relativeToChangelogFile="true"/>
    <include file="centerui/005-client-search-view.xml" relativeToChangelogFile="true"/>
    <include file="centerui/006-management-service-role.xml" relativeToChangelogFile="true"/>
    <include file="centerui/007-management-request-view.xml" relativeToChangelogFile="true"/>

    <include file="centerui/202207011455-identifiers-remove-redundant-type-field.xml" relativeToChangelogFile="true"/>

    <changeSet id="apikey-test" author="ricardas" context="test">
        <!--TODO this is just for POC-->
        <sql>
            -- noinspection SqlResolve
            INSERT INTO apikey
                (id,   encodedkey)
            VALUES (1,    'ad26a8235b3e847dc0b9ac34733d5acb39e2b6af634796e7eebe171165cdf2d1');
            ALTER SEQUENCE apikey_id_seq RESTART WITH 1001000;

            INSERT INTO apikey_roles
                (id,    apikey_id, role)
            VALUES (1000001, 1,       'XROAD_SYSTEM_ADMINISTRATOR'),
                   (1000002, 1,       'XROAD_SECURITY_OFFICER'),
                   (1000003, 1,       'XROAD_REGISTRATION_OFFICER');
            ALTER SEQUENCE apikey_roles_id_seq RESTART WITH 1001000;

        </sql>
    </changeSet>
    <!-- must be the last one -->
    <changeSet id="separate-admin-user" author="niis" context="admin" runAlways="true" runOnChange="true" runOrder="last">
        <sql splitStatements="false" dbms="postgresql"><![CDATA[
            grant usage on schema "${db_schema}" to "${db_user}";
        grant select,update,insert,delete on all tables in schema "${db_schema}" to "${db_user}";
            grant select,usage on all sequences in schema "${db_schema}" to "${db_user}";
            grant execute on all functions in schema "${db_schema}" to "${db_user}";
            revoke insert,update,delete on databasechangelog, databasechangeloglock from "${db_user}";
            ]]>
        </sql>
    </changeSet>


</databaseChangeLog>
